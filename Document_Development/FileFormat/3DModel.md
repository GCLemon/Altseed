## 3Dモデルファイル

### 概要

通常の3Dモデルの描画に必要なパラメーターを持つファイルである。

### 構造

#### 全体

|型|説明|
|---|---|
| 特別				| 'M','D','L',0-4byteの識別子 |
| int				| バージョン情報 |
| 配列<ボーン>			| ボーン情報 |
| 配列<メッシュ> 		| メッシュ情報 |
| 配列<アニメーションソース>	| アニメーションソース情報 |
| 配列<アニメーションクリップ>	| アニメーションクリップ情報 |

先頭にはファイルの種類を識別するための識別子とバージョン情報が記録されている。

#### ボーン

|型|説明|
|---|---|
| 文字列	| 名前	|
| int		| 親ボーンインデックス	|
| int		| 回転順序	|
| matrix44	| 親に対する変換行列	|

ボーンが記録されている。
ボーンは予め、親ボーンのインデックスが自身のインデックスよりも大きくならないようにソートされている。

#### メッシュ

|型|説明|
|---|---|
| 配列<メッシュ(分割済)>	| メッシュ(分割済)	|
| 配列<材質>	| 材質情報	|

#### メッシュ(分割済)

|型|説明|
|---|---|
| 配列<頂点>	| 頂点情報	|
| 配列<面>	| 面情報	|
| 配列<面材質>	| 面材質情報	|
| 配列<ボーン接続>	| ボーン接続情報	|

ボーン数が32を超える場合、1回の描画でメッシュを描画できないため、メッシュは分割されて記録される。

##### 頂点

|型|説明|
|---|---|
| Vector3DF	| 頂点座標	|
| Vector3DF	| 法線	|
| Vector3DF	| 従法線	|
| Vector2DF	| UV	|
| Vector2DF	| 補助UV	|
| Color		| 頂点カラー	|
| uint8[4]	| 頂点ウエイト	|	
| uint8[4]	| 頂点ウエイトインデックス(分割済)	|
| uint8[4]	| 頂点ウエイトインデックス(オリジナル)	|	
	
座標は右手系、手前がZ、上がYである。UVは左上が(0,0)で、右下が(1,1)である。

##### 面

|型|説明|
|---|---|
| int	| 頂点1	|
| int	| 頂点2	|
| int	| 頂点3	|

##### 面材質

|型|説明|
|---|---|
| int	| 材質インデックス	|
| int	| 面数	|

面数分の面を指定されたインデックスの材質で描画する。2つ目以降の材質で描画される面は、今まで描画された面の合計値をオフセットとして描画される。

##### ボーン接続

|型|説明|
|---|---|
| int		| 参照先のボーンインデックス	|
| matrix44	| 描画用逆行列	|

頂点ウエイトインデックスに対応するボーンの情報を取得するための情報が記録されている。

##### 材質

|型|説明|
|---|---|
| int		| 種類(外部入力1,内部0)	|

###### 外部入力の場合

|型|説明|
|---|---|
| 文字列		| 材質ファイルへの相対パス	|

###### 内部入力の場合

|型|説明|
|---|---|
| 文字列		| 色テクスチャへの相対パス	|
| 文字列		| 法線テクスチャへの相対パス	|
| 文字列		| スペキュラテクスチャへの相対パス	|

#### アニメーションソース

|型|説明|
|---|---|
| 文字列		| アニメーション名	|
| 配列<キーフレームアニメーション>		| アニメーション情報	|

実際にアニメーションの情報を格納する。

#### アニメーションクリップ

|型|説明|
|---|---|
| 文字列	| アニメーション名	|
| int		| アニメーションソースのインデックス	|

アニメーションソースを元に構成されるアニメーション


#### キーフレームアニメーション

|型|説明|
|---|---|
| 文字列	| 対象名	|
| 配列<キーフレーム>		| キーフレーム	|

対象名は「ボーン名.(pos/rot/scl).(x/y/z/w)」とする。


#### キーフレーム

|型|説明|
|---|---|
| Vector2DF	| 時間,値	|
| Vector2DF	| 左手座標	|
| Vector2DF	| 右手座標	|
| int		| 補間方法	|

対象名は「ボーン名.(pos/rot/scl).(x/y/z/w)」とする。

#### 回転順序

|値|説明|
|---|---|
| 10	| クオータニオン	|
| 11	| XZY	|
| 12	| XYZ	|
| 13	| ZXY	|
| 14	| ZYX	|
| 15	| YXZ	|
| 16	| YZX	|
| 18	| 軸回転	|

#### 補間方法

|値|説明|
|---|---|
| 1	| 定数	|
| 2	| 線形	|
| 3	| 三次	|

